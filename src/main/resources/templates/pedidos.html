<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{base :: head}">
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>La Masseria - Pedidos</title>
    <style>
        .floating-cart-btn {
            position: fixed;
            bottom: 120px;
            left: 30px;
            width: 70px;
            height: 70px;
            background: #c49b63;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 3px solid white;
            cursor: pointer;
        }
        .floating-cart-btn .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div th:replace="~{base :: navbar}"></div>

    <!-- Page Header -->
    <div class="container-fluid page-header mb-5 position-relative overlay-bottom">
        <div class="d-flex flex-column align-items-center justify-content-center pt-0 pt-lg-5" style="min-height: 300px">
            <h1 class="display-4 mb-3 mt-0 mt-lg-5 text-white text-uppercase">Mis Pedidos</h1>
            <div class="d-inline-flex mb-lg-5">
                <p class="m-0 text-white"><a class="text-white" href="/">Inicio</a></p>
                <p class="m-0 text-white px-2">/</p>
                <p class="m-0 text-white">Pedidos</p>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante del carrito -->
    <div class="floating-cart-btn" id="floating-cart-btn" onclick="activarTabCarrito()">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-count" id="floating-cart-count">0</span>
    </div>

    <!-- ====== CONTENIDO PRINCIPAL CON TABS ====== -->
    <div class="container-fluid py-4 bg-light">
        <div class="container">

            <!-- Bienvenida breve -->
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <h5 class="mb-0 font-weight-bold">
                        <i class="fa fa-user-circle text-secondary mr-2"></i>
                        Hola, <span th:text="${usuario.nombres}">Usuario</span>
                    </h5>
                    <small class="text-muted">Gestiona tu carrito y revisa tu historial de pedidos.</small>
                </div>
                <a href="/menu/desayunos" class="btn btn-sm btn-outline-warning">
                    <i class="fa fa-utensils mr-1"></i>Ver Men√∫
                </a>
            </div>

            <!-- ===== NAV TABS ===== -->
            <ul class="nav nav-tabs" id="pedidosTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link font-weight-bold" id="link-tab-carrito"
                       data-toggle="tab" href="#tab-carrito" role="tab">
                        <i class="fa fa-shopping-cart mr-2"></i>Mi Carrito
                        <span class="badge badge-pill badge-warning ml-1" id="badge-carrito">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link font-weight-bold" id="link-tab-historial"
                       data-toggle="tab" href="#tab-historial" role="tab">
                        <i class="fa fa-history mr-2"></i>Mis Pedidos
                        <span class="badge badge-pill badge-secondary ml-1"
                              th:text="${historialPedidos != null ? #lists.size(historialPedidos) : 0}">0</span>
                    </a>
                </li>
            </ul>

            <!-- ===== TAB CONTENT ===== -->
            <div class="tab-content bg-white shadow-sm rounded-bottom" id="pedidosTabContent">

                <!-- ==================== TAB 1: CARRITO ==================== -->
                <div class="tab-pane fade" id="tab-carrito" role="tabpanel">
                    <div class="p-4">

                        <!-- Carrito vac√≠o -->
                        <div id="empty-cart" class="text-center py-5" style="display:none;">
                            <i class="fas fa-shopping-cart fa-4x text-warning mb-3"></i>
                            <h4 class="text-muted mb-2">Tu carrito est√° vac√≠o</h4>
                            <p class="text-muted mb-4">Agrega productos deliciosos para comenzar tu pedido.</p>
                            <a href="/menu/desayunos" class="btn btn-outline-warning btn-lg rounded-pill px-4">
                                <i class="fa fa-utensils mr-2"></i>Ver Men√∫
                            </a>
                        </div>

                        <!-- Tabla del carrito -->
                        <div id="carrito-container" style="display:none;">
                            <div class="table-responsive rounded shadow-sm">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Producto</th>
                                            <th>Imagen</th>
                                            <th>Precio</th>
                                            <th>Cantidad</th>
                                            <th>Total</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="items-carrito"></tbody>
                                    <tfoot class="bg-light">
                                        <tr>
                                            <td colspan="4" class="text-right font-weight-bold py-3">Total a pagar:</td>
                                            <td colspan="2" class="font-weight-bold py-3 text-success">
                                                <strong id="total-carrito">S/ 0.00</strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- M√©todo de entrega -->
                            <div class="card mt-4 border-left border-warning" style="border-left-width:4px !important;">
                                <div class="card-body">
                                    <h6 class="font-weight-bold mb-3">
                                        <i class="fa fa-truck mr-2 text-warning"></i>¬øC√≥mo deseas recibir tu pedido?
                                    </h6>
                                    <div class="d-flex flex-wrap" style="gap:20px;">
                                        <div class="custom-control custom-radio">
                                            <input type="radio" class="custom-control-input" name="metodoEntrega" id="recoger" value="RECOGER" checked>
                                            <label class="custom-control-label" for="recoger">
                                                <i class="fa fa-store mr-1 text-warning"></i>Ir a recoger
                                            </label>
                                        </div>
                                        <div class="custom-control custom-radio">
                                            <input type="radio" class="custom-control-input" name="metodoEntrega" id="domicilio" value="DOMICILIO">
                                            <label class="custom-control-label" for="domicilio">
                                                <i class="fa fa-truck mr-1 text-info"></i>Env√≠o a domicilio
                                            </label>
                                        </div>
                                    </div>
                                    <div id="campo-direccion" class="mt-3" style="display:none;">
                                        <input type="text" class="form-control"
                                               id="direccion" placeholder="Ingresa tu direcci√≥n completa"
                                               th:value="${direccion}">
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="d-flex flex-wrap justify-content-center mt-4" style="gap:12px;">
                                <button id="btn-confirmar" class="btn btn-success btn-lg rounded-pill px-4">
                                    <i class="fas fa-check mr-2"></i>Confirmar Pedido
                                </button>
                                <a href="/menu/desayunos" class="btn btn-outline-warning btn-lg rounded-pill px-4">
                                    <i class="fas fa-plus mr-2"></i>Seguir comprando
                                </a>
                            </div>
                        </div>

                        <!-- Formulario de pago -->
                        <div id="formulario-pago" class="mt-4" style="display:none;">
                            <h5 class="font-weight-bold mb-3">
                                <i class="fa fa-credit-card mr-2 text-success"></i>Confirma tus datos para finalizar
                            </h5>
                            <form id="form-pedido" method="POST" th:action="@{/pedidos/guardar}">
                                <input type="hidden" name="cliente" th:value="${nombreCompleto}" id="cliente-hidden">
                                <input type="hidden" name="correo"  th:value="${email}"          id="correo-hidden">
                                <input type="hidden" name="metodoEntrega" id="metodoEntrega-hidden" value="RECOGER">
                                <input type="hidden" name="direccion"     id="direccion-hidden"    th:value="${direccion}">
                                <input type="hidden" name="total"         id="total-hidden"         value="0">
                                <input type="hidden" name="detalles"      id="detalles-hidden"      value="">

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="font-weight-bold small text-uppercase text-muted">
                                                <i class="fas fa-user mr-1"></i>Nombre completo
                                            </label>
                                            <input type="text" class="form-control"
                                                   id="nombre" name="nombre" th:value="${nombreCompleto}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="font-weight-bold small text-uppercase text-muted">
                                                <i class="fas fa-envelope mr-1"></i>Correo electr√≥nico
                                            </label>
                                            <input type="email" class="form-control"
                                                   id="correo" name="correo" th:value="${email}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="font-weight-bold small text-uppercase text-muted">
                                                <i class="fas fa-phone mr-1"></i>Tel√©fono
                                            </label>
                                            <input type="tel" class="form-control"
                                                   id="telefono" name="telefono" th:value="${telefono}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="font-weight-bold small text-uppercase text-muted">
                                                <i class="fas fa-sticky-note mr-1"></i>Nota (opcional)
                                            </label>
                                            <input type="text" class="form-control"
                                                   id="notas" name="notas" placeholder="Escribe una nota para tu pedido">
                                        </div>
                                        <div class="form-group">
                                            <label class="font-weight-bold small text-uppercase text-muted">
                                                <i class="fas fa-credit-card mr-1"></i>M√©todo de pago
                                            </label>
                                            <select class="form-control" id="metodo-pago" name="metodoPago" required>
                                                <option value="">Selecciona un m√©todo</option>
                                                <option value="EFECTIVO">Efectivo</option>
                                                <option value="YAPE">Yape</option>
                                                <option value="PLIN">Plin</option>
                                                <option value="TARJETA">Tarjeta</option>
                                            </select>
                                        </div>
                                        <div id="extra-pago"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-light border-0 h-100">
                                            <div class="card-body">
                                                <h6 class="font-weight-bold mb-3">
                                                    <i class="fa fa-receipt mr-2"></i>Resumen del pedido
                                                </h6>
                                                <div id="resumen-items"></div>
                                                <hr>
                                                <p class="h5 font-weight-bold mb-0">
                                                    Total: <span id="resumen-total" class="text-success">S/ 0.00</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg btn-block rounded-pill mt-3">
                                    <i class="fas fa-check-circle mr-2"></i>Finalizar Pedido
                                </button>
                            </form>
                        </div>

                    </div>
                </div><!-- /tab-carrito -->

                <!-- ==================== TAB 2: HISTORIAL ==================== -->
                <div class="tab-pane fade" id="tab-historial" role="tabpanel">
                    <div class="p-4">

                        <!-- Panel de filtros -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body">
                                <form method="get" action="/pedidos" id="formHistorial">
                                    <div class="row align-items-end">

                                        <!-- Botones de per√≠odo -->
                                        <div class="col-12 mb-3">
                                            <p class="text-muted small font-weight-bold text-uppercase mb-2">
                                                <i class="fa fa-clock mr-1"></i>Per√≠odo
                                            </p>
                                            <div>
                                                <a th:href="@{/pedidos(periodo='hoy',    nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == 'hoy'    and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    <i class="fa fa-sun mr-1"></i>Hoy
                                                </a>
                                                <a th:href="@{/pedidos(periodo='7dias',   nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == '7dias'  and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    7 d√≠as
                                                </a>
                                                <a th:href="@{/pedidos(periodo='15dias',  nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == '15dias' and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    15 d√≠as
                                                </a>
                                                <a th:href="@{/pedidos(periodo='1mes',    nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == '1mes'   and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    1 mes
                                                </a>
                                                <a th:href="@{/pedidos(periodo='3meses',  nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == '3meses' and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    3 meses
                                                </a>
                                                <a th:href="@{/pedidos(periodo='todos',   nombreProducto=${nombreProducto})} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary mr-1 mb-1"
                                                   th:classappend="${periodoActivo == 'todos'  and (fechaInicio == null or fechaInicio == '') ? ' active' : ''}">
                                                    <i class="fa fa-list mr-1"></i>Todos
                                                </a>
                                            </div>
                                        </div>

                                        <!-- Fechas y producto -->
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <label class="text-muted small font-weight-bold text-uppercase mb-1 d-block">
                                                <i class="fa fa-calendar mr-1"></i>Desde
                                            </label>
                                            <input type="date" name="fechaInicio" class="form-control form-control-sm"
                                                   th:value="${fechaInicio}">
                                        </div>
                                        <div class="col-md-3 col-sm-6 mb-3">
                                            <label class="text-muted small font-weight-bold text-uppercase mb-1 d-block">
                                                <i class="fa fa-calendar mr-1"></i>Hasta
                                            </label>
                                            <input type="date" name="fechaFin" class="form-control form-control-sm"
                                                   th:value="${fechaFin}">
                                        </div>
                                        <div class="col-md-4 col-sm-8 mb-3">
                                            <label class="text-muted small font-weight-bold text-uppercase mb-1 d-block">
                                                <i class="fa fa-search mr-1"></i>Buscar producto
                                            </label>
                                            <input type="text" name="nombreProducto" class="form-control form-control-sm"
                                                   placeholder="Ej: Cappuccino, Croissant..."
                                                   th:value="${nombreProducto}">
                                        </div>
                                        <div class="col-md-2 col-sm-4 mb-3">
                                            <label class="d-block invisible small mb-1">_</label>
                                            <div class="d-flex">
                                                <button type="submit" class="btn btn-sm btn-warning flex-fill mr-1">
                                                    <i class="fa fa-filter mr-1"></i>Filtrar
                                                </button>
                                                <a th:href="@{/pedidos} + '#tab-historial'"
                                                   class="btn btn-sm btn-outline-secondary" title="Limpiar">
                                                    <i class="fa fa-times"></i>
                                                </a>
                                            </div>
                                        </div>

                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Contador -->
                        <p class="text-muted small mb-3">
                            <i class="fa fa-receipt mr-1"></i>
                            <strong th:text="${historialPedidos != null ? #lists.size(historialPedidos) : 0}">0</strong>
                            pedido(s) encontrado(s).
                        </p>

                        <!-- Sin resultados -->
                        <div th:if="${historialPedidos == null or #lists.isEmpty(historialPedidos)}"
                             class="text-center py-5 text-muted">
                            <i class="fa fa-box-open fa-3x mb-3"></i>
                            <h5>No hay pedidos en este per√≠odo</h5>
                            <p class="small mb-0">Prueba otro filtro o realiza tu primer pedido.</p>
                        </div>

                        <!-- Tabla -->
                        <div th:if="${historialPedidos != null and not #lists.isEmpty(historialPedidos)}"
                             class="table-responsive rounded shadow-sm">
                            <table class="table table-hover mb-0">
                                <thead class="thead-dark">
                                    <tr>
                                        <th class="pl-3" style="width:70px;">#</th>
                                        <th>Fecha</th>
                                        <th>Productos</th>
                                        <th class="text-right">Total</th>
                                        <th>Pago</th>
                                        <th>Entrega</th>
                                        <th class="text-center">Estado</th>
                                        <th class="text-center">Detalle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <th:block th:each="ped : ${historialPedidos}">
                                        <tr>
                                            <td class="pl-3 align-middle text-muted font-weight-bold small">
                                                #<span th:text="${ped.id}"></span>
                                            </td>
                                            <td class="align-middle">
                                                <span class="d-block" th:text="${#temporals.format(ped.fechaPedido,'dd/MM/yyyy')}"></span>
                                                <small class="text-muted" th:text="${#temporals.format(ped.fechaPedido,'HH:mm')}"></small>
                                            </td>
                                            <td class="align-middle">
                                                <th:block th:each="det : ${ped.detalles}">
                                                    <span class="badge badge-secondary mr-1 mb-1"
                                                          th:text="${det.cantidad} + ' x ' + ${det.producto.nombre}"></span>
                                                </th:block>
                                                <span th:if="${ped.detalles == null or #lists.isEmpty(ped.detalles)}"
                                                      class="text-muted">‚Äî</span>
                                            </td>
                                            <td class="align-middle text-right font-weight-bold">
                                                S/ <span th:text="${#numbers.formatDecimal(ped.total,1,2)}"></span>
                                            </td>
                                            <td class="align-middle">
                                                <span th:switch="${ped.metodoPago}">
                                                    <span th:case="'EFECTIVO'"><i class="fa fa-money-bill-wave mr-1 text-success"></i>Efectivo</span>
                                                    <span th:case="'YAPE'"><i class="fa fa-mobile-alt mr-1 text-primary"></i>Yape</span>
                                                    <span th:case="'PLIN'"><i class="fa fa-mobile-alt mr-1 text-info"></i>Plin</span>
                                                    <span th:case="'TARJETA'"><i class="fa fa-credit-card mr-1 text-primary"></i>Tarjeta</span>
                                                    <span th:case="*" th:text="${ped.metodoPago}"></span>
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                <span th:if="${ped.tipoEntrega == 'RECOGER'}">
                                                    <i class="fa fa-store mr-1 text-warning"></i>Recoger
                                                </span>
                                                <span th:if="${ped.tipoEntrega == 'DOMICILIO'}">
                                                    <i class="fa fa-truck mr-1 text-info"></i>Domicilio
                                                </span>
                                            </td>
                                            <td class="align-middle text-center">
                                                <span th:switch="${ped.estado}">
                                                    <span th:case="'PENDIENTE'"   class="badge badge-warning">Pendiente</span>
                                                    <span th:case="'EN_PROCESO'"  class="badge badge-info">En proceso</span>
                                                    <span th:case="'ENVIADO'"     class="badge badge-primary">Enviado</span>
                                                    <span th:case="'ENTREGADO'"   class="badge badge-success">Entregado</span>
                                                    <span th:case="'CANCELADO'"   class="badge badge-danger">Cancelado</span>
                                                    <span th:case="*" class="badge badge-secondary" th:text="${ped.estado}"></span>
                                                </span>
                                            </td>
                                            <td class="align-middle text-center">
                                                <button class="btn btn-sm btn-outline-secondary btn-toggle-ped"
                                                        type="button"
                                                        th:attr="data-target='ped-det-' + ${ped.id}">
                                                    <i class="fa fa-chevron-down"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <!-- Fila detalle expandible -->
                                        <tr th:id="'ped-det-' + ${ped.id}" class="table-warning d-none">
                                            <td colspan="8" class="px-4 py-3">
                                                <div class="row">
                                                    <div class="col-md-7">
                                                        <h6 class="font-weight-bold mb-2">
                                                            <i class="fa fa-list-ul mr-1"></i>Productos del pedido
                                                        </h6>
                                                        <table class="table table-sm table-borderless bg-transparent mb-0">
                                                            <thead class="text-muted small">
                                                                <tr>
                                                                    <th>Producto</th>
                                                                    <th class="text-center">Cant.</th>
                                                                    <th class="text-right">P. Unit.</th>
                                                                    <th class="text-right">Subtotal</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr th:each="det : ${ped.detalles}">
                                                                    <td th:text="${det.producto.nombre}"></td>
                                                                    <td class="text-center" th:text="${det.cantidad}"></td>
                                                                    <td class="text-right">S/ <span th:text="${#numbers.formatDecimal(det.precioUnitario,1,2)}"></span></td>
                                                                    <td class="text-right font-weight-bold">S/ <span th:text="${#numbers.formatDecimal(det.subtotal,1,2)}"></span></td>
                                                                </tr>
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td colspan="3" class="text-right font-weight-bold border-top pt-2">Total:</td>
                                                                    <td class="text-right font-weight-bold border-top pt-2">
                                                                        S/ <span th:text="${#numbers.formatDecimal(ped.total,1,2)}"></span>
                                                                    </td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <h6 class="font-weight-bold mb-2">
                                                            <i class="fa fa-info-circle mr-1"></i>Informaci√≥n
                                                        </h6>
                                                        <table class="table table-sm table-borderless bg-transparent mb-0 small">
                                                            <tr>
                                                                <th class="text-muted" style="width:110px;">M√©todo pago:</th>
                                                                <td th:text="${ped.metodoPago}"></td>
                                                            </tr>
                                                            <tr>
                                                                <th class="text-muted">Tipo entrega:</th>
                                                                <td th:text="${ped.tipoEntrega}"></td>
                                                            </tr>
                                                            <tr th:if="${ped.tipoEntrega == 'DOMICILIO'}">
                                                                <th class="text-muted">Direcci√≥n:</th>
                                                                <td th:text="${ped.direccionEntrega}"></td>
                                                            </tr>
                                                            <tr th:if="${ped.notas != null and ped.notas != ''}">
                                                                <th class="text-muted">Notas:</th>
                                                                <td th:text="${ped.notas}"></td>
                                                            </tr>
                                                        </table>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </th:block>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div><!-- /tab-historial -->

            </div><!-- /tab-content -->
        </div>
    </div>
    <!-- FIN CONTENIDO PRINCIPAL -->

    <div th:replace="~{base :: footer}"></div>
    <div th:replace="~{base :: scripts}"></div>

    <script>
    window.actualizarContadorCarrito = function() {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
        const el = document.getElementById('floating-cart-count');
        if (el) el.textContent = totalItems;
        const badge = document.getElementById('badge-carrito');
        if (badge) badge.textContent = totalItems;
    };

    function activarTabCarrito() {
        $('#link-tab-carrito').tab('show');
    }

    function mostrarMensaje(tipo, texto) {
        const alerta = $(`
            <div class="alert alert-${tipo} alert-dismissible fade show"
                 role="alert"
                 style="position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;">
                <i class="fa ${tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                ${texto}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>`);
        $('body').append(alerta);
        setTimeout(() => alerta.fadeOut(500, function() { $(this).remove(); }), 5000);
    }

    $(document).ready(function() {
        cargarCarrito();

        // ===== Determinar qu√© tab mostrar al cargar =====
        const params = new URLSearchParams(window.location.search);
        const tienesFiltro = params.has('periodo') || params.has('fechaInicio')
                          || params.has('fechaFin') || params.has('nombreProducto');
        if (tienesFiltro) {
            $('#link-tab-historial').tab('show');
        } else {
            $('#link-tab-carrito').tab('show');
        }

        // ===== M√©todo de entrega =====
        $('input[name="metodoEntrega"]').change(function() {
            $('#metodoEntrega-hidden').val($(this).val());
            if ($(this).val() === 'DOMICILIO') {
                $('#campo-direccion').slideDown(300);
            } else {
                $('#campo-direccion').slideUp(300);
            }
        });

        // ===== Confirmar pedido =====
        $('#btn-confirmar').click(function() {
            const items = JSON.parse(localStorage.getItem('carrito')) || [];
            if (items.length === 0) { mostrarMensaje('warning', 'Tu carrito est√° vac√≠o'); return; }

            const total = items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            const detalles = items.map(item => ({
                id: item.id, nombre: item.nombre, cantidad: item.cantidad,
                precio: item.precio, subtotal: item.precio * item.cantidad
            }));
            $('#total-hidden').val(total.toFixed(2));
            $('#detalles-hidden').val(JSON.stringify(detalles));

            const metodoEntrega = $('input[name="metodoEntrega"]:checked').val();
            $('#metodoEntrega-hidden').val(metodoEntrega);
            if (metodoEntrega === 'DOMICILIO') {
                $('#direccion-hidden').val($('#direccion').val());
            }

            $('#formulario-pago').slideDown(500);
            $('html, body').animate({ scrollTop: $('#formulario-pago').offset().top - 80 }, 500);
        });

        // ===== M√©todo de pago =====
        $('#metodo-pago').change(function() {
            const m = $(this).val();
            let html = '';
            if (m === 'YAPE') {
                html = `<div class="alert alert-info mt-2">
                    <strong>üì± Yape:</strong> 912 594 051<br>
                    <small>Paga con Yape y te contactaremos para confirmar</small></div>`;
            } else if (m === 'PLIN') {
                html = `<div class="alert alert-info mt-2">
                    <strong>üíô Plin:</strong> 912 594 051<br>
                    <small>Paga con Plin y confirma tu pago</small></div>`;
            }
            $('#extra-pago').html(html);
        });

        // ===== Env√≠o del formulario (AJAX) =====
        $('#form-pedido').on('submit', function(e) {
            e.preventDefault();
            const items = JSON.parse(localStorage.getItem('carrito')) || [];
            const metodoEntrega = $('input[name="metodoEntrega"]:checked').val();

            if (items.length === 0) { mostrarMensaje('warning', 'Tu carrito est√° vac√≠o'); return; }
            if (metodoEntrega === 'DOMICILIO' && !$('#direccion').val()) {
                mostrarMensaje('warning', 'Por favor ingresa tu direcci√≥n'); return;
            }
            if (!$('#nombre').val() || !$('#telefono').val() || !$('#metodo-pago').val()) {
                mostrarMensaje('warning', 'Por favor completa todos los campos obligatorios'); return;
            }

            const submitBtn = $(this).find('button[type="submit"]');
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...');

            $.ajax({
                url: '/pedidos/guardar', type: 'POST',
                data: {
                    cliente: $('#nombre').val(), correo: $('#correo').val(),
                    telefono: $('#telefono').val(), total: $('#total-hidden').val(),
                    metodoEntrega: $('#metodoEntrega-hidden').val(),
                    direccion: $('#direccion-hidden').val() || '',
                    metodoPago: $('#metodo-pago').val(),
                    notas: $('#notas').val(), detalles: $('#detalles-hidden').val()
                },
                success: function() {
                    localStorage.removeItem('carrito');
                    actualizarContadorCarrito();
                    submitBtn.prop('disabled', false).html('<i class="fas fa-check-circle mr-2"></i>Finalizar Pedido');
                    mostrarMensaje('success', '¬°Pedido realizado con √©xito! Te contactaremos pronto.');
                    setTimeout(() => { window.location.href = '/pedidos'; }, 2000);
                },
                error: function(xhr) {
                    submitBtn.prop('disabled', false).html('<i class="fas fa-check-circle mr-2"></i>Finalizar Pedido');
                    const msg = (xhr.responseJSON && xhr.responseJSON.message)
                        ? xhr.responseJSON.message : 'Error al procesar el pedido. Intenta nuevamente.';
                    mostrarMensaje('danger', msg);
                }
            });
        });

        // ===== Toggle filas de detalle =====
        document.querySelectorAll('.btn-toggle-ped').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var fila = document.getElementById(this.getAttribute('data-target'));
                if (!fila) return;
                fila.classList.toggle('d-none');
                var icon = this.querySelector('i');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
        });

        // ===== Al enviar filtros, activar tab historial =====
        document.getElementById('formHistorial').addEventListener('submit', function() {
            this.action = '/pedidos';
            sessionStorage.setItem('abrirHistorial', '1');
        });
    });

    function cargarCarrito() {
        const items = JSON.parse(localStorage.getItem('carrito')) || [];
        actualizarContadorCarrito();

        if (items.length === 0) {
            $('#carrito-container').hide();
            $('#empty-cart').show();
            return;
        }
        $('#carrito-container').show();
        $('#empty-cart').hide();

        let html = '', total = 0;
        items.forEach((item, index) => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            html += `
                <tr>
                    <td class="align-middle">${item.nombre}</td>
                    <td class="align-middle">
                        <img src="${item.imagen}"
                             class="rounded border"
                             style="width:55px;height:55px;object-fit:cover;"
                             alt="${item.nombre}">
                    </td>
                    <td class="align-middle">S/ ${item.precio.toFixed(2)}</td>
                    <td class="align-middle">
                        <div class="input-group input-group-sm" style="width:110px;">
                            <div class="input-group-prepend">
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="actualizarCantidad(${index}, -1)">‚àí</button>
                            </div>
                            <input type="text" class="form-control text-center font-weight-bold"
                                   value="${item.cantidad}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"
                                        onclick="actualizarCantidad(${index}, 1)">+</button>
                            </div>
                        </div>
                    </td>
                    <td class="align-middle font-weight-bold">S/ ${subtotal.toFixed(2)}</td>
                    <td class="align-middle">
                        <button class="btn btn-sm btn-outline-danger" onclick="eliminarItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });

        $('#items-carrito').html(html);
        $('#total-carrito').html(`S/ ${total.toFixed(2)}`);
        $('#total-hidden').val(total.toFixed(2));
        actualizarResumen(items, total);
    }

    function actualizarResumen(items, total) {
        let html = '<ul class="list-unstyled mb-0">';
        items.forEach(item => {
            html += `<li class="d-flex justify-content-between mb-1">
                        <span>${item.cantidad}√ó ${item.nombre}</span>
                        <span class="font-weight-bold">S/ ${(item.precio * item.cantidad).toFixed(2)}</span>
                     </li>`;
        });
        html += '</ul>';
        $('#resumen-items').html(html);
        $('#resumen-total').html(`S/ ${total.toFixed(2)}`);
    }

    function actualizarCantidad(index, cambio) {
        const items = JSON.parse(localStorage.getItem('carrito')) || [];
        let q = items[index].cantidad + cambio;
        if (q < 1) q = 1;
        if (q > 10) q = 10;
        items[index].cantidad = q;
        localStorage.setItem('carrito', JSON.stringify(items));
        cargarCarrito();
    }

    function eliminarItem(index) {
        const items = JSON.parse(localStorage.getItem('carrito')) || [];
        items.splice(index, 1);
        localStorage.setItem('carrito', JSON.stringify(items));
        cargarCarrito();
    }
    </script>

    <div th:replace="~{base :: floating-buttons}"></div>
</body>
</html>
